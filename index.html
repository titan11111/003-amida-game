<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚ã¿ã ãã˜å¤§å†’é™º</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow-x: hidden;
    }

    #game-container {
      background: white;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      max-width: 90vw;
      width: 600px;
      text-align: center;
      position: relative;
    }

    h1 {
      color: #4a5568;
      margin-bottom: 20px;
      font-size: 2em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    #game-info {
      display: flex;
      justify-content: space-around;
      margin-bottom: 20px;
      background: #f7fafc;
      padding: 15px;
      border-radius: 10px;
      border: 2px solid #e2e8f0;
    }

    .info-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .info-label {
      font-size: 12px;
      color: #718096;
      font-weight: bold;
    }

    .info-value {
      font-size: 18px;
      font-weight: bold;
      color: #2d3748;
      margin-top: 5px;
    }

    #story-area {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      padding: 20px;
      margin: 20px 0;
      border-radius: 15px;
      border: 3px solid #f56500;
    }

    .story-text {
      font-size: 16px;
      line-height: 1.6;
      color: #2d3748;
      margin-bottom: 15px;
    }

    #character-selection {
      margin: 20px 0;
      padding: 20px;
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      border-radius: 15px;
      border: 3px solid #38b2ac;
    }

    .character-icon {
      width: 80px;
      height: 80px;
      margin: 10px;
      cursor: pointer;
      border: 4px solid transparent;
      border-radius: 50%;
      transition: all 0.3s ease;
      background: white;
      padding: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 2em;
    }

    .character-icon:hover {
      border-color: #4299e1;
      transform: scale(1.1);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .character-icon.selected {
      border-color: #f56500;
      background: #fed7d7;
      transform: scale(1.2);
    }

    #amidakuji-area {
      margin: 20px 0;
      position: relative;
    }

    #amidakujiCanvas {
      border: 3px solid #4a5568;
      border-radius: 10px;
      background: white;
      max-width: 100%;
      cursor: pointer;
    }

    #result-area {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      padding: 20px;
      border-radius: 15px;
      margin: 20px 0;
      border: 3px solid #f56500;
    }

    #result-image {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      margin: 10px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3em;
      border: 4px solid white;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      background: white;
    }

    #result-message {
      font-size: 18px;
      font-weight: bold;
      margin: 15px 0;
      color: #2d3748;
    }

    #score-change {
      font-size: 16px;
      font-weight: bold;
      margin: 10px 0;
    }

    .positive {
      color: #38a169;
    }

    .negative {
      color: #e53e3e;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      margin: 10px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    }

    button:active {
      transform: translateY(0);
    }

    #game-over-area {
      background: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%);
      color: white;
      padding: 30px;
      border-radius: 20px;
      margin: 20px 0;
    }

    .firework {
      position: fixed;
      width: 50px;
      height: 50px;
      background: radial-gradient(circle, #ffd700, #ff6347);
      border-radius: 50%;
      animation: firework 1s ease-out forwards;
      pointer-events: none;
      z-index: 1000;
    }

    @keyframes firework {
      0% {
        transform: scale(0);
        opacity: 1;
      }
      50% {
        transform: scale(1.5);
        opacity: 0.8;
      }
      100% {
        transform: scale(3);
        opacity: 0;
      }
    }

    .particle {
      position: fixed;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      animation: particle 2s ease-out forwards;
      pointer-events: none;
      z-index: 1000;
    }

    @keyframes particle {
      0% {
        transform: translate(0, 0);
        opacity: 1;
      }
      100% {
        transform: translate(var(--dx), var(--dy));
        opacity: 0;
      }
    }

    #sound-controls {
      position: absolute;
      top: 10px;
      right: 10px;
    }

    #mute-button {
      background: #4299e1;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 600px) {
      #game-container {
        padding: 15px;
        margin: 10px;
        width: 95vw;
      }

      h1 {
        font-size: 1.5em;
      }

      .character-icon {
        width: 60px;
        height: 60px;
        margin: 5px;
        font-size: 1.5em;
      }

      #game-info {
        flex-direction: column;
        gap: 10px;
      }

      .info-item {
        flex-direction: row;
        justify-content: space-between;
      }

      .story-text {
        font-size: 14px;
      }

      #amidakujiCanvas {
        width: 100%;
        height: auto;
      }

      button {
        font-size: 14px;
        padding: 10px 20px;
        margin: 5px;
      }

      #result-image {
        width: 80px;
        height: 80px;
        font-size: 2em;
      }
    }
  </style>
</head>
<body>
  <div id="game-container">
    <div id="sound-controls">
      <button id="mute-button" title="éŸ³å£°ON/OFF">ğŸ”Š</button>
    </div>

    <h1>ğŸŒŸ ã‚ã¿ã ãã˜å¤§å†’é™º ğŸŒŸ</h1>

    <div id="game-info">
      <div class="info-item">
        <span class="info-label">ã‚¹ãƒ†ãƒ¼ã‚¸</span>
        <span class="info-value" id="current-level">1</span>
      </div>
      <div class="info-item">
        <span class="info-label">ã‚¹ã‚³ã‚¢</span>
        <span class="info-value" id="current-score">0</span>
      </div>
      <div class="info-item">
        <span class="info-label">æ®‹ã‚Šãƒ©ã‚¤ãƒ•</span>
        <span class="info-value" id="remaining-turns">â¤ï¸â¤ï¸â¤ï¸</span>
      </div>
    </div>

    <div id="story-area">
      <div class="story-text" id="story-text">
        ğŸ° é­”æ³•ã®ç‹å›½ã§å®ç‰©ã‚’æ¢ã™å†’é™ºãŒå§‹ã¾ã‚‹ã‚ˆï¼<br>
        ã‚ã¿ã ãã˜ã‚’ä½¿ã£ã¦æ­£ã—ã„é“ã‚’é¸ã‚“ã§ã€å®ç‰©ã‚’è¦‹ã¤ã‘ã‚ˆã†ï¼
      </div>
    </div>

    <div id="character-selection">
      <p><strong>ğŸ§™â€â™€ï¸ å†’é™ºè€…ã‚’é¸ã‚“ã§ã­ï¼</strong></p>
      <div class="character-icon" data-char="0">ğŸ§™â€â™€ï¸</div>
      <div class="character-icon" data-char="1">ğŸ§™â€â™‚ï¸</div>
      <div class="character-icon" data-char="2">ğŸ‘¸</div>
    </div>

    <div id="amidakuji-area">
      <canvas id="amidakujiCanvas" width="500" height="500"></canvas>
    </div>

    <div id="result-area" style="display: none;">
      <div id="result-image">ğŸ</div>
      <p id="result-message"></p>
      <p id="score-change"></p>
      <button id="next-button">æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸ ğŸš€</button>
      <button id="reset-button">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ ğŸ”„</button>
    </div>

    <div id="game-over-area" style="display: none;">
      <h2>ğŸ‰ å†’é™ºå®Œäº†ï¼ ğŸ‰</h2>
      <p id="final-score"></p>
      <p id="final-message"></p>
      <button id="restart-button">æ–°ã—ã„å†’é™ºã‚’å§‹ã‚ã‚‹ ğŸŒŸ</button>
    </div>
  </div>

  <script>
    // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†
    let gameState = {
      level: 1,
      score: 0,
      lives: 3,
      selectedCharacter: 0,
      isGameActive: false,
      isMuted: false,
      bridges: []
    };

    // ã‚¹ãƒ†ãƒ¼ã‚¸ã”ã¨ã®å›ºå®šã‚ã¿ã ãã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸1ã‹ã‚‰6æœ¬ã€ä»¥é™+3æœ¬ï¼‰
    const amidakujiPatterns = {
      1: [
        // ã‚¹ãƒ†ãƒ¼ã‚¸1: 6æœ¬ã®æ¨ªæ£’
        { line1: 1, line2: 2, yPercent: 15 },
        { line1: 3, line2: 4, yPercent: 25 },
        { line1: 2, line2: 3, yPercent: 40 },
        { line1: 1, line2: 2, yPercent: 55 },
        { line1: 3, line2: 4, yPercent: 70 },
        { line1: 2, line2: 3, yPercent: 85 }
      ],
      2: [
        // ã‚¹ãƒ†ãƒ¼ã‚¸2: 9æœ¬ã®æ¨ªæ£’
        { line1: 1, line2: 2, yPercent: 12 },
        { line1: 3, line2: 4, yPercent: 12 },
        { line1: 2, line2: 3, yPercent: 25 },
        { line1: 1, line2: 2, yPercent: 38 },
        { line1: 3, line2: 4, yPercent: 51 },
        { line1: 2, line2: 3, yPercent: 64 },
        { line1: 1, line2: 2, yPercent: 77 },
        { line1: 3, line2: 4, yPercent: 90 },
        { line1: 2, line2: 3, yPercent: 95 }
      ],
      3: [
        // ã‚¹ãƒ†ãƒ¼ã‚¸3: 12æœ¬ã®æ¨ªæ£’
        { line1: 1, line2: 2, yPercent: 10 },
        { line1: 3, line2: 4, yPercent: 10 },
        { line1: 2, line2: 3, yPercent: 20 },
        { line1: 1, line2: 2, yPercent: 30 },
        { line1: 3, line2: 4, yPercent: 40 },
        { line1: 2, line2: 3, yPercent: 50 },
        { line1: 1, line2: 2, yPercent: 60 },
        { line1: 3, line2: 4, yPercent: 70 },
        { line1: 2, line2: 3, yPercent: 80 },
        { line1: 1, line2: 2, yPercent: 87 },
        { line1: 3, line2: 4, yPercent: 94 },
        { line1: 2, line2: 3, yPercent: 98 }
      ],
      4: [
        // ã‚¹ãƒ†ãƒ¼ã‚¸4: 15æœ¬ã®æ¨ªæ£’
        { line1: 1, line2: 2, yPercent: 8 },
        { line1: 3, line2: 4, yPercent: 8 },
        { line1: 2, line2: 3, yPercent: 16 },
        { line1: 1, line2: 2, yPercent: 24 },
        { line1: 3, line2: 4, yPercent: 32 },
        { line1: 2, line2: 3, yPercent: 40 },
        { line1: 1, line2: 2, yPercent: 48 },
        { line1: 3, line2: 4, yPercent: 56 },
        { line1: 2, line2: 3, yPercent: 64 },
        { line1: 1, line2: 2, yPercent: 72 },
        { line1: 3, line2: 4, yPercent: 80 },
        { line1: 2, line2: 3, yPercent: 85 },
        { line1: 1, line2: 2, yPercent: 90 },
        { line1: 3, line2: 4, yPercent: 95 },
        { line1: 2, line2: 3, yPercent: 98 }
      ],
      5: [
        // ã‚¹ãƒ†ãƒ¼ã‚¸5: 18æœ¬ã®æ¨ªæ£’
        { line1: 1, line2: 2, yPercent: 7 },
        { line1: 3, line2: 4, yPercent: 7 },
        { line1: 2, line2: 3, yPercent: 14 },
        { line1: 1, line2: 2, yPercent: 21 },
        { line1: 3, line2: 4, yPercent: 28 },
        { line1: 2, line2: 3, yPercent: 35 },
        { line1: 1, line2: 2, yPercent: 42 },
        { line1: 3, line2: 4, yPercent: 49 },
        { line1: 2, line2: 3, yPercent: 56 },
        { line1: 1, line2: 2, yPercent: 63 },
        { line1: 3, line2: 4, yPercent: 70 },
        { line1: 2, line2: 3, yPercent: 77 },
        { line1: 1, line2: 2, yPercent: 82 },
        { line1: 3, line2: 4, yPercent: 87 },
        { line1: 2, line2: 3, yPercent: 92 },
        { line1: 1, line2: 2, yPercent: 95 },
        { line1: 3, line2: 4, yPercent: 97 },
        { line1: 2, line2: 3, yPercent: 99 }
      ]
    };

    // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿
    const storyData = {
      1: {
        text: "ğŸ° é­”æ³•ã®ç‹å›½ã§å®ç‰©ã‚’æ¢ã™å†’é™ºãŒå§‹ã¾ã‚‹ã‚ˆï¼ã‚ã¿ã ãã˜ã‚’æ­£ã—ãè¾¿ã£ã¦å®ç‰©ã‚’è¦‹ã¤ã‘ã‚ˆã†ï¼",
        rewards: ["ğŸ’ ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰", "ğŸ‘‘ ç‹å† "],
        traps: ["ğŸ•·ï¸ ã‚¯ãƒ¢ã®å·£", "ğŸ’€ æ¯’ã‚­ãƒã‚³"]
      },
      2: {
        text: "ğŸŒŠ æµ·ã®ç¥æ®¿ã«åˆ°ç€ï¼æµ·è³Šã®å®ãŒéš ã•ã‚Œã¦ã„ã‚‹ã‚ˆã€‚æ¨ªæ£’ã‚’æ­£ã—ãæ¸¡ã£ã¦å®ã‚’æ‰‹ã«å…¥ã‚Œã‚ˆã†ï¼",
        rewards: ["ğŸ´â€â˜ ï¸ æµ·è³Šã®å®", "ğŸ¦œ ãŠã—ã‚ƒã¹ã‚Šã‚ªã‚¦ãƒ "],
        traps: ["ğŸ¦ˆ ã‚µãƒ¡ã®ç¾¤ã‚Œ", "ğŸ‘» å¹½éœŠèˆ¹"]
      },
      3: {
        text: "ğŸ”ï¸ é›²ã®ä¸Šã®å¤©ç©ºåŸï¼è¤‡é›‘ãªé“ã®ã‚Šã ã‘ã©ã€æ¨ªæ£’ã‚’è¾¿ã‚Œã°å¤©ä½¿ã®ç¥ç¦ãŒå¾…ã£ã¦ã„ã‚‹ï¼",
        rewards: ["ğŸ‘¼ å¤©ä½¿ã®ç¾½", "â­ æ˜Ÿã®ã‹ã‘ã‚‰"],
        traps: ["âš¡ é›·é›²", "â„ï¸ æ°·ã®ç‰¢ç„"]
      },
      4: {
        text: "ğŸŒ‹ ç«å±±ã®æ´çªŸï¼ã•ã‚‰ã«è¤‡é›‘ã«ãªã£ãŸé“ï¼ãƒ‰ãƒ©ã‚´ãƒ³ã®å®ç‰©åº«ã¸ç¶šãæ­£ã—ã„é“ã‚’è¦‹ã¤ã‘ã‚ˆã†ï¼",
        rewards: ["ğŸ‰ ãƒ‰ãƒ©ã‚´ãƒ³ã®åµ", "ğŸ’ ç«ã®æŒ‡è¼ª"],
        traps: ["ğŸŒ‹ æº¶å²©ã®æµã‚Œ", "ğŸ”¥ ç‚ã®ç½ "]
      },
      5: {
        text: "ğŸŒŒ å®‡å®™ã®æœã¦ï¼æœ€ã‚‚è¤‡é›‘ãªæœ€çµ‚è©¦ç·´ï¼æ¨ªæ£’ã®è¿·å®®ã‚’æŠœã‘ã¦å®‡å®™ã®ç§˜å®ã‚’æ‰‹ã«å…¥ã‚Œã‚ˆã†ï¼",
        rewards: ["ğŸŒŸ å®‡å®™ã®çŸ³", "ğŸ‘‘ æ˜Ÿã®ç‹å† "],
        traps: ["ğŸ•³ï¸ ãƒ–ãƒ©ãƒƒã‚¯ãƒ›ãƒ¼ãƒ«", "â˜„ï¸ éš•çŸ³ã®é›¨"]
      }
    };

    // DOMè¦ç´ ã®å–å¾—
    const canvas = document.getElementById('amidakujiCanvas');
    const ctx = canvas.getContext('2d');
    const characterIcons = document.querySelectorAll('.character-icon');
    const storyText = document.getElementById('story-text');
    const resultArea = document.getElementById('result-area');
    const gameOverArea = document.getElementById('game-over-area');
    const muteButton = document.getElementById('mute-button');

    // éŸ³å£°ç®¡ç†ã‚¯ãƒ©ã‚¹
    class SoundManager {
      constructor() {
        this.audioContext = null;
        this.sounds = {};
        this.initAudio();
      }

      async initAudio() {
        try {
          this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
          console.log('éŸ³å£°ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      }

      // 8ãƒ“ãƒƒãƒˆé¢¨éŸ³å£°ã®ç”Ÿæˆ
      createBeep(frequency, duration, volume = 0.1) {
        if (!this.audioContext || gameState.isMuted) return;

        const oscillator = this.audioContext.createOscillator();
        const gainNode = this.audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(this.audioContext.destination);

        oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
        oscillator.type = 'square';

        gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + 0.01);
        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration - 0.01);
        gainNode.gain.linearRampToValueAtTime(0, this.audioContext.currentTime + duration);

        oscillator.start(this.audioContext.currentTime);
        oscillator.stop(this.audioContext.currentTime + duration);
      }

      // åŠ¹æœéŸ³ãƒ¡ã‚½ãƒƒãƒ‰
      playClick() {
        this.createBeep(800, 0.1, 0.05);
      }

      playSuccess() {
        this.createBeep(523, 0.2, 0.1);
        setTimeout(() => this.createBeep(659, 0.2, 0.1), 200);
        setTimeout(() => this.createBeep(784, 0.3, 0.1), 400);
      }

      playFailure() {
        this.createBeep(300, 0.3, 0.1);
        setTimeout(() => this.createBeep(250, 0.3, 0.1), 300);
        setTimeout(() => this.createBeep(200, 0.5, 0.1), 600);
      }

      playLevelUp() {
        const notes = [523, 659, 784, 1047];
        notes.forEach((note, i) => {
          setTimeout(() => this.createBeep(note, 0.15, 0.08), i * 100);
        });
      }

      playMove() {
        this.createBeep(440, 0.05, 0.03);
      }

      async resumeAudio() {
        if (this.audioContext && this.audioContext.state === 'suspended') {
          await this.audioContext.resume();
        }
      }
    }

    const soundManager = new SoundManager();

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠå‡¦ç†
    characterIcons.forEach((icon, index) => {
      icon.addEventListener('click', async () => {
        await soundManager.resumeAudio();
        soundManager.playClick();
        
        characterIcons.forEach(i => i.classList.remove('selected'));
        icon.classList.add('selected');
        gameState.selectedCharacter = index;
        
        if (!gameState.isGameActive) {
          startGame();
        }
      });
    });

    // ãƒŸãƒ¥ãƒ¼ãƒˆãƒœã‚¿ãƒ³å‡¦ç†
    muteButton.addEventListener('click', async () => {
      await soundManager.resumeAudio();
      gameState.isMuted = !gameState.isMuted;
      muteButton.textContent = gameState.isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
      if (!gameState.isMuted) {
        soundManager.playClick();
      }
    });

    // ã‚ã¿ã ãã˜ã®æç”»
    function drawAmidakuji() {
      const width = canvas.width;
      const height = canvas.height;
      const lines = 4;
      const spacing = width / (lines + 1);
      const topMargin = 60;
      const bottomMargin = 80;
      const drawHeight = height - topMargin - bottomMargin;

      // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¯ãƒªã‚¢
      ctx.clearRect(0, 0, width, height);

      // èƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      const gradient = ctx.createLinearGradient(0, 0, 0, height);
      gradient.addColorStop(0, '#f0f9ff');
      gradient.addColorStop(1, '#e0e7ff');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, width, height);
      
      // ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¥èƒŒæ™¯æç”»
      drawStageBackground(width, height);

      // ç¸¦ç·šã‚’æç”»
      ctx.strokeStyle = '#4a5568';
      ctx.lineWidth = 5;
      for (let i = 1; i <= lines; i++) {
        const x = spacing * i;
        ctx.beginPath();
        ctx.moveTo(x, topMargin);
        ctx.lineTo(x, height - bottomMargin);
        ctx.stroke();
      }
      
      // ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¥è£…é£¾ (ç¸¦ç·šã®ä¸Šã«æç”»)
      drawStageDecorations(width, height);

      // ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã‚’æç”»
      for (let i = 1; i <= lines; i++) {
        const x = spacing * i;
        
        // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœãƒƒã‚¯ã‚¹
        ctx.fillStyle = '#667eea';
        ctx.fillRect(x - 35, 5, 70, 40);
        
        // ã‚¹ã‚¿ãƒ¼ãƒˆãƒ†ã‚­ã‚¹ãƒˆ
        ctx.fillStyle = 'white';
        ctx.font = 'bold 16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(`START`, x, 22);
        ctx.fillText(`${i}`, x, 38);
      }

      // ã‚´ãƒ¼ãƒ«åœ°ç‚¹ã‚’æç”»
      const currentStory = storyData[Math.min(gameState.level, 5)];
      const rewards = currentStory.rewards;
      const traps = currentStory.traps;
      const goalItems = [...rewards, ...traps];
      
      for (let i = 1; i <= lines; i++) {
        const x = spacing * i;
        const isReward = i <= rewards.length;
        
        // ã‚´ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹
        ctx.fillStyle = isReward ? '#48bb78' : '#f56565';
        ctx.fillRect(x - 45, height - 60, 90, 50);
        
        // ã‚´ãƒ¼ãƒ«ãƒ†ã‚­ã‚¹ãƒˆ
        ctx.fillStyle = 'white';
        ctx.font = 'bold 12px Arial';
        ctx.textAlign = 'center';
        
        const item = goalItems[i - 1] || 'ï¼Ÿ';
        const shortItem = item.length > 12 ? item.substring(0, 10) + '...' : item;
        ctx.fillText(shortItem, x, height - 30);
      }

      // å›ºå®šãƒ‘ã‚¿ãƒ¼ãƒ³ã§æ¨ªç·šï¼ˆæ©‹ï¼‰ã‚’æç”»
      const currentPattern = amidakujiPatterns[Math.min(gameState.level, 5)];
      gameState.bridges = [];
      
      currentPattern.forEach(bridge => {
        const x1 = spacing * bridge.line1;
        const x2 = spacing * bridge.line2;
        const y = topMargin + (drawHeight * bridge.yPercent / 100);
        
        // æ©‹ã‚’æç”»ï¼ˆå¤ªã‚ã§å®‰å®šã—ãŸç·šï¼‰
        ctx.strokeStyle = '#e53e3e';
        ctx.lineWidth = 8;
        ctx.beginPath();
        ctx.moveTo(x1, y);
        ctx.lineTo(x2, y);
        ctx.stroke();
        
        // æ©‹ã®ç«¯ç‚¹ã‚’æç”»ï¼ˆå††å½¢ã®è£…é£¾ï¼‰
        ctx.fillStyle = '#c53030';
        ctx.beginPath();
        ctx.arc(x1, y, 6, 0, 2 * Math.PI);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(x2, y, 6, 0, 2 * Math.PI);
        ctx.fill();
        
        gameState.bridges.push({ line1: bridge.line1, line2: bridge.line2, y: y });
      });

      // ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ã‚’è¨­å®š
      canvas.onclick = handleCanvasClick;
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¥èƒŒæ™¯æç”»
    function drawStageBackground(width, height) {
      const level = Math.min(gameState.level, 5);
      
      switch(level) {
        case 1: // é­”æ³•ã®ç‹å›½ - åŸã®èƒŒæ™¯
          const castleGradient = ctx.createLinearGradient(0, 0, 0, height);
          castleGradient.addColorStop(0, '#fef7cd'); // è–„ã„é‡‘è‰²
          castleGradient.addColorStop(0.3, '#fed7aa'); // ã‚ªãƒ¬ãƒ³ã‚¸
          castleGradient.addColorStop(1, '#c084fc'); // ç´«
          ctx.fillStyle = castleGradient;
          ctx.fillRect(0, 0, width, height);
          
          // é›²ã®è£…é£¾
          ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
          for(let i = 0; i < 5; i++) {
            const x = (width / 5) * i + 20;
            const y = 50 + Math.sin(i) * 20;
            drawCloud(x, y, 30);
          }
          break;
          
        case 2: // æµ·ã®ç¥æ®¿ - æµ·åº•èƒŒæ™¯
          const oceanGradient = ctx.createLinearGradient(0, 0, 0, height);
          oceanGradient.addColorStop(0, '#0ea5e9'); // æ˜ã‚‹ã„é’
          oceanGradient.addColorStop(0.5, '#0284c7'); // æµ·ã®é’
          oceanGradient.addColorStop(1, '#0f172a'); // æ·±æµ·ã®æš—é’
          ctx.fillStyle = oceanGradient;
          ctx.fillRect(0, 0, width, height);
          
          // æ³¡ã®è£…é£¾
          ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
          for(let i = 0; i < 8; i++) {
            const x = Math.random() * width;
            const y = Math.random() * height;
            const size = 3 + Math.random() * 8;
            ctx.beginPath();
            ctx.arc(x, y, size, 0, 2 * Math.PI);
            ctx.fill();
          }
          
          // æµ·è—»ã®è£…é£¾
          ctx.strokeStyle = 'rgba(34, 197, 94, 0.6)';
          ctx.lineWidth = 4;
          for(let i = 0; i < 3; i++) {
            const x = 50 + i * 150;
            drawSeaweed(x, height - 80);
          }
          break;
          
        case 3: // å¤©ç©ºåŸ - é›²ã¨ç©ºã®èƒŒæ™¯
          const skyGradient = ctx.createLinearGradient(0, 0, 0, height);
          skyGradient.addColorStop(0, '#f0f9ff'); // è–„ã„ç©ºè‰²
          skyGradient.addColorStop(0.3, '#7dd3fc'); // æ˜ã‚‹ã„ç©ºè‰²
          skyGradient.addColorStop(0.7, '#38bdf8'); // é’ç©º
          skyGradient.addColorStop(1, '#0284c7'); // æ·±ã„é’
          ctx.fillStyle = skyGradient;
          ctx.fillRect(0, 0, width, height);
          
          // å¤§ããªé›²ã®è£…é£¾
          ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
          for(let i = 0; i < 4; i++) {
            const x = (width / 4) * i + 30;
            const y = 100 + i * 80;
            drawCloud(x, y, 50 + i * 10);
          }
          
          // æ˜Ÿã®è£…é£¾
          ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
          for(let i = 0; i < 6; i++) {
            const x = 80 + i * 70;
            const y = 40 + Math.sin(i * 2) * 30;
            drawStar(x, y, 8);
          }
          break;
          
        case 4: // ç«å±±ã®æ´çªŸ - æº¶å²©ã¨ç‚ã®èƒŒæ™¯
          const volcanoGradient = ctx.createLinearGradient(0, 0, 0, height);
          volcanoGradient.addColorStop(0, '#451a03'); // æš—èŒ¶è‰²
          volcanoGradient.addColorStop(0.3, '#7c2d12'); // èŒ¶è‰²
          volcanoGradient.addColorStop(0.7, '#dc2626'); // èµ¤
          volcanoGradient.addColorStop(1, '#ff6b35'); // ã‚ªãƒ¬ãƒ³ã‚¸
          ctx.fillStyle = volcanoGradient;
          ctx.fillRect(0, 0, width, height);
          
          // æº¶å²©ã®è£…é£¾
          ctx.fillStyle = 'rgba(255, 107, 53, 0.7)';
          for(let i = 0; i < 5; i++) {
            const x = i * 100 + 25;
            const y = height - 60 + Math.sin(i * 3) * 10;
            ctx.beginPath();
            ctx.ellipse(x, y, 30, 8, 0, 0, 2 * Math.PI);
            ctx.fill();
          }
          
          // ç«èŠ±ã®è£…é£¾
          ctx.fillStyle = 'rgba(255, 193, 7, 0.8)';
          for(let i = 0; i < 10; i++) {
            const x = Math.random() * width;
            const y = Math.random() * (height * 0.7);
            const size = 2 + Math.random() * 4;
            ctx.beginPath();
            ctx.arc(x, y, size, 0, 2 * Math.PI);
            ctx.fill();
          }
          break;
          
        case 5: // å®‡å®™ - æ˜Ÿç©ºã¨éŠ€æ²³ã®èƒŒæ™¯
          const spaceGradient = ctx.createLinearGradient(0, 0, 0, height);
          spaceGradient.addColorStop(0, '#0f0f23'); // æ·±ã„ç´«
          spaceGradient.addColorStop(0.3, '#1e1b4b'); // æ¿ƒã„é’ç´«
          spaceGradient.addColorStop(0.7, '#312e81'); // é’ç´«
          spaceGradient.addColorStop(1, '#1e40af'); // é’
          ctx.fillStyle = spaceGradient;
          ctx.fillRect(0, 0, width, height);
          
          // æ˜Ÿã®è£…é£¾
          ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
          for(let i = 0; i < 20; i++) {
            const x = Math.random() * width;
            const y = Math.random() * height;
            const size = 1 + Math.random() * 3;
            if(Math.random() > 0.7) {
              drawStar(x, y, size * 2);
            } else {
              ctx.beginPath();
              ctx.arc(x, y, size, 0, 2 * Math.PI);
              ctx.fill();
            }
          }
          
          // éŠ€æ²³ã®è£…é£¾
          ctx.fillStyle = 'rgba(147, 51, 234, 0.4)';
          ctx.beginPath();
          ctx.ellipse(width/2, height/3, width*0.3, height*0.1, Math.PI/6, 0, 2 * Math.PI);
          ctx.fill();
          break;
        
        default:
          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèƒŒæ™¯ï¼ˆå¿µã®ãŸã‚ï¼‰
          const defaultGradient = ctx.createLinearGradient(0, 0, 0, height);
          defaultGradient.addColorStop(0, '#f0f9ff');
          defaultGradient.addColorStop(1, '#e0e7ff');
          ctx.fillStyle = defaultGradient;
          ctx.fillRect(0, 0, width, height);
          break;
      }
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¥è£…é£¾
    function drawStageDecorations(width, height) {
      const level = Math.min(gameState.level, 5);
      
      // ã‚¹ãƒ†ãƒ¼ã‚¸ç•ªå·è¡¨ç¤º
      ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
      ctx.font = 'bold 24px Arial';
      ctx.textAlign = 'left';
      ctx.fillText(`STAGE ${level}`, 10, 35);
      
      // ã‚¹ãƒ†ãƒ¼ã‚¸åè¡¨ç¤º
      const stageNames = {
        1: 'ğŸ° é­”æ³•ã®ç‹å›½',
        2: 'ğŸŒŠ æµ·ã®ç¥æ®¿', 
        3: 'ğŸ”ï¸ å¤©ç©ºåŸ',
        4: 'ğŸŒ‹ ç«å±±ã®æ´çªŸ',
        5: 'ğŸŒŒ å®‡å®™ã®æœã¦'
      };
      
      ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
      ctx.font = 'bold 16px Arial';
      ctx.fillText(stageNames[level], 10, 55);
    }

    // é›²ã®æç”»ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function drawCloud(x, y, size) {
      ctx.beginPath();
      ctx.arc(x, y, size, 0, 2 * Math.PI);
      ctx.arc(x + size * 0.6, y, size * 0.8, 0, 2 * Math.PI);
      ctx.arc(x + size * 1.2, y, size * 0.6, 0, 2 * Math.PI);
      ctx.arc(x + size * 0.3, y - size * 0.5, size * 0.7, 0, 2 * Math.PI);
      ctx.arc(x + size * 0.9, y - size * 0.3, size * 0.5, 0, 2 * Math.PI);
      ctx.fill();
    }

    // æ˜Ÿã®æç”»ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function drawStar(x, y, size) {
      const spikes = 5;
      const step = Math.PI / spikes;
      let rotation = Math.PI / 2 * 3;
      let cx = x, cy = y;
      
      ctx.beginPath();
      ctx.moveTo(cx, cy - size);
      
      for(let i = 0; i < spikes; i++) {
        cx = x + Math.cos(rotation) * size;
        cy = y + Math.sin(rotation) * size;
        ctx.lineTo(cx, cy);
        rotation += step;
        
        cx = x + Math.cos(rotation) * (size * 0.5);
        cy = y + Math.sin(rotation) * (size * 0.5);
        ctx.lineTo(cx, cy);
        rotation += step;
      }
      
      ctx.lineTo(x, y - size);
      ctx.closePath();
      ctx.fill();
    }

    // æµ·è—»ã®æç”»ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function drawSeaweed(x, startY) {
      ctx.beginPath();
      ctx.moveTo(x, startY);
      
      for(let i = 0; i < 5; i++) {
        const offsetX = Math.sin(i * 0.5) * 15;
        const y = startY - i * 20;
        ctx.quadraticCurveTo(x + offsetX, y - 10, x + offsetX * 0.5, y);
      }
      
      ctx.stroke();
    }

    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
    function handleCanvasClick(e) {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      
      const clickX = (e.clientX - rect.left) * scaleX;
      const clickY = (e.clientY - rect.top) * scaleY;
      
      const spacing = canvas.width / 5;
      
      // ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã®ã‚¯ãƒªãƒƒã‚¯åˆ¤å®š
      for (let j = 1; j <= 4; j++) {
        const startX = spacing * j;
        if (Math.abs(clickX - startX) < 45 && clickY < 60) {
          followPath(j);
          break;
        }
      }
    }

    // ãƒ‘ã‚¹ã‚’è¾¿ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ­£ã—ã„ã‚ã¿ã ãã˜ãƒ«ãƒ¼ãƒ«ï¼‰
    function followPath(startLine) {
      soundManager.resumeAudio();
      soundManager.playClick();
      
      let currentLine = startLine;
      const width = canvas.width;
      const height = canvas.height;
      const spacing = width / 5;
      let y = 60;
      const stepSize = 1.8; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é€Ÿåº¦ï¼ˆå…ƒã®3ã‹ã‚‰1.8ã«å¤‰æ›´ = 60%ï¼‰
      const bridgeHitRange = stepSize * 0.5; // æ¨ªæ£’ã¨ã®è¡çªåˆ¤å®šç¯„å›²
      
      // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¯ãƒªãƒƒã‚¯ã‚’ç„¡åŠ¹åŒ–
      canvas.onclick = null;
      
      // æ©‹ã‚’yåº§æ¨™ã§æ˜‡é †ã«ã‚½ãƒ¼ãƒˆ
      const sortedBridges = gameState.bridges.sort((a, b) => a.y - b.y);
      let nextBridgeIndex = 0;
      
      const animateStep = () => {
        // ã‚ã¿ã ãã˜ã‚’å†æç”»
        drawAmidakuji();
        
        let movedHorizontally = false;
        
        // ã‚ã¿ã ãã˜ãƒ«ãƒ¼ãƒ«ï¼šæ¨ªæ£’ã«é­é‡ã—ãŸã‚‰å¿…ãšæ¨ªã«ç§»å‹•
        for (let i = nextBridgeIndex; i < sortedBridges.length; i++) {
            const bridge = sortedBridges[i];
            
            // ç¾åœ¨ã®ç¸¦ç·šã¨æ¨ªæ£’ã®yåº§æ¨™ãŒè¿‘ãã€ã‹ã¤ã€ã¾ã ãã®æ¨ªæ£’ã‚’é€šéã—ã¦ã„ãªã„å ´åˆ
            // y < bridge.y ã¯æ¨ªæ£’ã‚’å®Œå…¨ã«è¶…ãˆã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª
            if (y + stepSize >= bridge.y && y < bridge.y && 
                (currentLine === bridge.line1 || currentLine === bridge.line2)) {
                
                // æ¨ªç§»å‹•å‡¦ç†
                const targetLine = currentLine === bridge.line1 ? bridge.line2 : bridge.line1;
                
                // yã‚’æ¨ªæ£’ã®Yåº§æ¨™ã«è¨­å®šï¼ˆæ­£ç¢ºãªæ¨ªç§»å‹•ã®å§‹ç‚¹ï¼‰
                y = bridge.y; 
                
                // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®æç”»ï¼ˆæ¨ªç§»å‹•ã®ç¬é–“ã‚’è¦‹ã›ã‚‹ãŸã‚ã«ä¸€æ™‚çš„ã«æç”»ï¼‰
                drawCharacter(spacing * currentLine, y);
                
                // æ¨ªç§»å‹•å¾Œã®ç·šã«åˆ‡ã‚Šæ›¿ãˆã‚‹
                currentLine = targetLine;
                soundManager.playMove();
                movedHorizontally = true;
                
                // æ¨ªæ£’ã‚’ä¹—ã‚Šè¶ŠãˆãŸå¾Œã®æ¬¡ã®ç¸¦ç·šã«ç§»å‹•ã—ãŸä½ç½®ã‹ã‚‰å†ã‚¹ã‚¿ãƒ¼ãƒˆã™ã‚‹ãŸã‚ã«ã€yã‚’å°‘ã—ã ã‘é€²ã‚ã‚‹
                y += stepSize; 
                
                // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§ã“ã®æ¨ªæ£’ã‚’å†ãƒã‚§ãƒƒã‚¯ã—ãªã„ã‚ˆã†ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é€²ã‚ã‚‹
                nextBridgeIndex = i + 1; 
                
                // 1ã‚¹ãƒ†ãƒƒãƒ—ã§æ¨ªæ£’ã¯1æœ¬ã ã‘æ¸¡ã‚‹
                break;
            }
        }
        
        // æ¨ªç§»å‹•ãŒãªã„å ´åˆã¯ä¸‹ã«ç§»å‹•
        if (!movedHorizontally) {
            y += stepSize; 
        }
        
        // ç¾åœ¨ä½ç½®ã‚’æç”»
        drawCharacter(spacing * currentLine, y);
        
        if (y < height - 80) {
          requestAnimationFrame(animateStep);
        } else {
          showResult(currentLine);
        }
      };
      
      // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æç”»ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
      function drawCharacter(x, y) {
        // å½±ã‚’æç”»
        ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
        ctx.beginPath();
        ctx.arc(x + 3, y + 3, 15, 0, 2 * Math.PI);
        ctx.fill();
        
        // ãƒ¡ã‚¤ãƒ³ã®å††ã‚’æç”»
        ctx.fillStyle = '#f56500';
        ctx.strokeStyle = '#d69e2e';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(x, y, 12, 0, 2 * Math.PI);
        ctx.fill();
        ctx.stroke();
        
        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’æç”»
        ctx.font = '28px Arial';
        ctx.textAlign = 'center';
        const characters = ['ğŸ§™â€â™€ï¸', 'ğŸ§™â€â™‚ï¸', 'ğŸ‘¸'];
        ctx.fillText(characters[gameState.selectedCharacter], x, y + 10);
      }
      
      animateStep();
    }
    
    // ... (ä»¥ä¸‹ã®é–¢æ•°ã¯å¤‰æ›´ãªã—)

    // çµæœè¡¨ç¤º
    function showResult(goalLine) {
      const currentStory = storyData[Math.min(gameState.level, 5)];
      const rewards = currentStory.rewards;
      const isReward = goalLine <= rewards.length;
      
      let message, scoreChange, emoji;
      
      if (isReward) {
        const rewardItem = rewards[goalLine - 1];
        message = `ğŸ‰ ãŠã‚ã§ã¨ã†ï¼${rewardItem}ã‚’è¦‹ã¤ã‘ãŸã‚ˆï¼`;
        scoreChange = 100 * gameState.level;
        gameState.score += scoreChange;
        emoji = 'ğŸ';
        soundManager.playSuccess();
        createFireworks();
      } else {
        const trapItem = currentStory.traps[goalLine - rewards.length - 1];
        message = `ğŸ˜… ã‚ã‚‰ã‚‰...${trapItem}ã«ã²ã£ã‹ã‹ã£ã¡ã‚ƒã£ãŸï¼`;
        scoreChange = -50;
        gameState.score = Math.max(0, gameState.score + scoreChange);
        gameState.lives--;
        emoji = 'ğŸ’€';
        soundManager.playFailure();
      }
      
      // çµæœè¡¨ç¤º
      document.getElementById('result-image').textContent = emoji;
      document.getElementById('result-message').textContent = message;
      document.getElementById('score-change').textContent = 
        scoreChange > 0 ? `+${scoreChange}ãƒã‚¤ãƒ³ãƒˆï¼` : `${scoreChange}ãƒã‚¤ãƒ³ãƒˆ...`;
      document.getElementById('score-change').className = scoreChange > 0 ? 'positive' : 'negative';
      
      updateDisplay();
      resultArea.style.display = 'block';
      
      // ã‚²ãƒ¼ãƒ çµ‚äº†ãƒã‚§ãƒƒã‚¯
      if (gameState.lives <= 0) {
        setTimeout(showGameOver, 2000);
      }
    }

    // èŠ±ç«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    function createFireworks() {
      for (let i = 0; i < 5; i++) {
        setTimeout(() => {
          const firework = document.createElement('div');
          firework.className = 'firework';
          firework.style.left = Math.random() * window.innerWidth + 'px';
          firework.style.top = Math.random() * window.innerHeight + 'px';
          document.body.appendChild(firework);
          
          // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«è¿½åŠ 
          for (let j = 0; j < 8; j++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = firework.style.left;
            particle.style.top = firework.style.top;
            particle.style.background = `hsl(${Math.random() * 360}, 100%, 60%)`;
            
            const angle = (j / 8) * 2 * Math.PI;
            const distance = 100;
            particle.style.setProperty('--dx', Math.cos(angle) * distance + 'px');
            particle.style.setProperty('--dy', Math.sin(angle) * distance + 'px');
            
            document.body.appendChild(particle);
            
            setTimeout(() => particle.remove(), 2000);
          }
          
          setTimeout(() => firework.remove(), 1000);
        }, i * 200);
      }
    }

    // è¡¨ç¤ºæ›´æ–°
    function updateDisplay() {
      document.getElementById('current-level').textContent = gameState.level;
      document.getElementById('current-score').textContent = gameState.score;
      
      let heartsDisplay = '';
      for (let i = 0; i < gameState.lives; i++) {
        heartsDisplay += 'â¤ï¸';
      }
      for (let i = gameState.lives; i < 3; i++) {
        heartsDisplay += 'ğŸ–¤';
      }
      document.getElementById('remaining-turns').textContent = heartsDisplay;
      
      // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
      const currentStory = storyData[Math.min(gameState.level, 5)];
      storyText.textContent = currentStory.text;
    }

    // ã‚²ãƒ¼ãƒ é–‹å§‹
    function startGame() {
      gameState.isGameActive = true;
      resultArea.style.display = 'none';
      gameOverArea.style.display = 'none';
      drawAmidakuji();
      updateDisplay();
    }

    // æ¬¡ã®ãƒ¬ãƒ™ãƒ«
    document.getElementById('next-button').addEventListener('click', () => {
      soundManager.playClick();
      gameState.level++;
      if (gameState.level > 5) {
        // å…¨ãƒ¬ãƒ™ãƒ«ã‚¯ãƒªã‚¢
        showGameOver(true);
      } else {
        soundManager.playLevelUp();
        startGame();
      }
    });

    // ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('reset-button').addEventListener('click', () => {
      soundManager.playClick();
      startGame();
    });

    // ã‚²ãƒ¼ãƒ çµ‚äº†ç”»é¢
    function showGameOver(isComplete = false) {
      let message;
      if (isComplete) {
        message = 'ğŸ† ã™ã¹ã¦ã®å†’é™ºã‚’ã‚¯ãƒªã‚¢ï¼å›ã¯çœŸã®å†’é™ºè€…ã ï¼å®‡å®™ã®ç§˜å¯†ã‚’ã™ã¹ã¦è§£ãæ˜ã‹ã—ãŸï¼';
        soundManager.playLevelUp();
      } else {
        message = 'ğŸ’” å†’é™ºã¯ã“ã“ã¾ã§...ã§ã‚‚å›ãªã‚‰å¿…ãšã‚¯ãƒªã‚¢ã§ãã‚‹ã‚ˆï¼å†æŒ‘æˆ¦ã—ã¦ã¿ã‚ˆã†ï¼';
      }
      
      document.getElementById('final-score').textContent = `æœ€çµ‚ã‚¹ã‚³ã‚¢: ${gameState.score}ç‚¹`;
      document.getElementById('final-message').textContent = message;
      gameOverArea.style.display = 'block';
      resultArea.style.display = 'none';
    }

    // ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
    document.getElementById('restart-button').addEventListener('click', () => {
      soundManager.playClick();
      gameState = {
        level: 1,
        score: 0,
        lives: 3,
        selectedCharacter: gameState.selectedCharacter,
        isGameActive: false,
        isMuted: gameState.isMuted,
        bridges: []
      };
      gameOverArea.style.display = 'none';
      updateDisplay();
      drawAmidakuji();
    });

    // åˆæœŸåŒ–
    drawAmidakuji();
    updateDisplay();

    // ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ
    if ('ontouchstart' in window) {
      canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        const clickX = (touch.clientX - rect.left) * scaleX;
        const clickY = (touch.clientY - rect.top) * scaleY;
        
        const spacing = canvas.width / 5;
        for (let j = 1; j <= 4; j++) {
          const startX = spacing * j;
          if (Math.abs(clickX - startX) < 45 && clickY < 60) {
            followPath(j);
            break;
          }
        }
      });
    }
  </script>
</body>
</html>
